pipeline {
    agent any

    environment {
        CI = 'true'
        // Mot de passe pour le repository Nexus
    }

    stages {
        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }
        stage('Build and Package') {
            steps {
                sh 'npm run build'
                sh 'tar -zcvf my-react-app.tar.gz build/'
            }
        }
        stage('Test') {
            steps {
                sh 'npm test'
            }
        }
   
        stage('Deploy to Nexus') {
            steps {
                script {
                    def componentsPath = "${env.WORKSPACE}/my-react-app.tar.gz"
                    def nexusUrl = 'http://192.99.35.61:8081'
                    def nexusUsername = 'exosdata'
                    def nexusPassword = 'stage'
                    def nexusRepository = 'simple'
                    sh "curl -u ${nexusUsername}:${nexusPassword} --upload-file ${componentsPath} ${nexusUrl}/repository/${nexusRepository}/my-react-app.tar.gz"
                    sh "npm config set registry ${nexusUrl}/repository/${nexusRepository}/"
                    sh "npm login --registry=${nexusUrl}/repository/${nexusRepository} --user=${nexusUsername} --password=${nexusPassword}"
                    sh "npm publish"
                }
            }
        }
    }
}
